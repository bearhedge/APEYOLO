"""
Python script used for testing Websockets via CP API   |  Certain requests like sbd+{} ssd+{} and sld+{} will require the IBKR Account ID {accountId} be included 

This script assumes you've already received an SSO Bearer Token for CP API use. 
    Lines 18 & 19: Enter your SSO Bearer Token & (optional) accountId which is the U-account or DU-account number

The Websocket request to send is specified in line 90:
    ws.send('smd+12087792+{"fields":["84","85","86","88","7219"]}')   
"""

import json
import requests
import pprint

#====================================================================================================================
#-=-=-=-==---=-=-=-=-======-==-=-=-=-==--=-=-INPUTS=-===-=-==-=-=-=-----=-=-=-=-==-=-=-====-=-=-====-==-=-=-=-===-=-=
#====================================================================================================================
BearerToken = "BEARER"
accountId = 'ACCOUNTID'


#====================================================================================================================
#-=-=-=-==---=-=-=-=-======-==-=-=-=-==--=-=-Tickle Request=-===-=-==-=-=-=-----=-=-=-=-==-=-=-====-=-=-====-==-=-=-=
#====================================================================================================================
clientPortalUrl = 'https://api.ibkr.com'

method = 'GET'
url = f'{clientPortalUrl}/v1/api/tickle'

body = {}
replybody = {}

headers={}
headers["Authorization"] = "Bearer "+ str(BearerToken)
headers["User-Agent"] = "python/3.11"

#-=-=-=-==---=-=-=-=-======-==-=-=-=-==--=-=-=-=----=-=-=-==-=-=-===-=-==-=-=-=-----=-=-=-=-==-=-=-===-=-=-=-==---=-=-=-=-======-==-=-=-=-==--=-=-=-=----=-=-=-==-=-=-===-=-==-=-=-=-----=-=-=-=-==-=-=-===
session_object = requests.Session()

RESP_HEADERS_TO_PRINT = ["Content-Type", "Content-Length", "Date", "Set-Cookie", "User-Agent"]
print("")

def pretty_request_response(resp: requests.Response) -> str:
    """Print request and response legibly."""
    req = resp.request
    rqh = '\n'.join(f"{k}: {v}" for k, v in req.headers.items())
    rqh = rqh.replace(', ', ',\n    ')
    rqb = f"\n{pprint.pformat(json.loads(req.body))}\n" if req.body else ""
    try:
        rsb = f"\n{pprint.pformat(resp.json())}\n" if resp.text else ""
    except json.JSONDecodeError:
        rsb = resp.text
    rsh = '\n'.join([f"{k}: {v}" for k, v in resp.headers.items() if k in RESP_HEADERS_TO_PRINT])
    return_str = '\n'.join([
        #80*'-',
        '-----------REQUEST-----------',
        f"{req.method} {req.url}",
        "",
        rqh,
        f"{rqb}",
        "",
        '-----------RESPONSE-----------',
        f"{resp.status_code} {resp.reason}",
        rsh,
        f"{rsb}\n",
        "",
    ])
    return return_str


#====================================================================================================================
#-=-=-=-==---=-=-=-=-======-==-=-=-=-==--=-=-WEBSOCKETS=-===-=-==-=-=-=-----=-=-=-=-==-=-=-=-=-=-=-==-===-=-==-=---==
#====================================================================================================================
import websocket
import time

tickle_request = requests.request(method=method, url=url, headers=headers)
print(pretty_request_response(tickle_request))

global TICKLE_COOKIE
TICKLE_COOKIE = tickle_request.json()['session']


def on_open(ws):
    print("Opened Connection")
    print("-----------------")
    time.sleep(1)
    
    ##### Send the ws request (Market data / Order Updates / PnL / etc.) #####                 #Specify the Websocket request - https://ibkrcampus.com/ibkr-api-page/cpapi-v1/#websockets
    ws.send('smd+12087792+{"fields":["84","85","86","88","7219"]}')                            #Available Market Data fields  - https://ibkrcampus.com/ibkr-api-page/cpapi-v1/#market-data-fields   
    #ws.send(f'sbd+{accountId}+12087792+IDEALPRO')          
    #ws.send('smh+265598+{"period": "1d","bar": "1min","source": "trades","format": "%o/%c/%h/%l"}')           
      
    #ws.send(f'sld+{accountId}')
    #ws.send(f'ssd+{accountId}')

    #ws.send('sor+{}')
    #ws.send('str+{"realtimeUpdatesOnly": true, "days": 7}')
    #ws.send('spl+{}')
    #ws.send('tic')  
    
    
    ##### Pass-in a list of CONIDs to stream market data for (CONID_list) #####
    # for item in CONID_list:
    #     string1 = 'smd+'                                                                
    #     string2 = f'{item}'
    #     string3 = '+{"fields":["84","85","86","88","7219"]}'
    #     smdreq = string1+string2+string3
    #     print("smd request = ", smdreq)                                                         #Print the CONID+smd request we're making via Websocket
    
    #     ws.send(smdreq)                                         
    #     time.sleep(0.5)
    
    ##### NOTE: "Invalid format specifier" error - adjust the ws.send() request and ensure this is a string which contains the type of request/accountId/CONID/etc. #####


def on_message(ws, message):
    print(message)

def on_error(ws, error):
    print(error)

def on_close(ws, r1, r2):
    print("## CLOSED! ##")
    print(f"r1:{r1}")
    print(f"r2:{r2}")

if __name__ == "__main__":
    ws = websocket.WebSocketApp(
        url=f"wss://api.ibkr.com/v1/api/ws?",
        on_open=on_open,
        on_message=on_message,
        on_error=on_error,
        on_close=on_close,
        header=["User-Agent: python/3.11"],
        cookie=f"api={TICKLE_COOKIE}"
    )
    ws.run_forever()
